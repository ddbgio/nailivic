#!/usr/bin/env bash

set -euo pipefail

echo "üß™ Setting up development database ..."

PASSWORD="mysecretpassword"

# set go path
export PATH=$PATH:/usr/local/go/bin
export DEBUG=true

# require root
if [ "$(id -u)" != "0" ]; then
  echo "‚ùå root required" 1>&2
  exit 1
fi

sudo docker compose up -d
sleep 2
trap "sudo docker compose down" EXIT

# check a simple connecton with psql
echo "üîç Checking Postgres container ..."
if ! psql \
  "postgresql://postgres:$PASSWORD@localhost:5432/postgres" \
  -c "SELECT 'Connected OK using psql' AS status;"; then
    echo "‚ùå psql failed"
    exit 1
fi
echo "üü¢ Test Postgres container is up!"

if [ $# -eq 0 ]; then
  # Keep the container open for 5 minutes and print logs
  echo "No command provided."
  echo "Keeping open and printing container logs ..."
  sudo docker logs -f postgres
  exit 0
fi

echo "‚ñ∂Ô∏è  Running commmand ..."
printf "%s@%s:-# %s\n" "$(whoami)" "$(hostname)" "$*"

# run the commands passed in
if ! "$@"; then
  echo "‚ùå failed"
  exit 1
fi
